"""Unit tests for market."""
import base64

from src.slab import SLAB_HEADER_LAYOUT, SLAB_LAYOUT, SLAB_NODE_LAYOUT

HEX_DATA = "0900000000000000020000000000000008000000000000000400000000000000010000001e00000000000040952fe4da5c1f3c860200000004000000030000000d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d7b0000000000000000000000000000000200000002000000000000a0ca17726dae0f1e43010000001111111111111111111111111111111111111111111111111111111111111111410100000000000000000000000000000200000001000000d20a3f4eeee073c3f60fe98e010000000d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d7b000000000000000000000000000000020000000300000000000040952fe4da5c1f3c8602000000131313131313131313131313131313131313131313131313131313131313131340e20100000000000000000000000000010000001f0000000500000000000000000000000000000005000000060000000d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d7b0000000000000000000000000000000200000004000000040000000000000000000000000000001717171717171717171717171717171717171717171717171717171717171717020000000000000000000000000000000100000020000000000000a0ca17726dae0f1e430100000001000000020000000d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d0d7b000000000000000000000000000000040000000000000004000000000000000000000000000000171717171717171717171717171717171717171717171717171717171717171702000000000000000000000000000000030000000700000005000000000000000000000000000000171717171717171717171717171717171717171717171717171717171717171702000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
DATA = bytes.fromhex(HEX_DATA)


def test_parse_node():
    """Test the parsing logic for a SLAB node."""
    # base64_data = "CQAAAAAAAAACAAAAAAAAAAgAAAAAAAAABAAAAAAAAAABAAAAHgAAAAAAAECVL+TaXB88hgIAAAAEAAAAAwAAAA0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDXsAAAAAAAAAAAAAAAAAAAACAAAAAgAAAAAAAKDKF3Jtrg8eQwEAAAAREREREREREREREREREREREREREREREREREREREREREUEBAAAAAAAAAAAAAAAAAAACAAAAAQAAANIKP07u4HPD9g/pjgEAAAANDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDXsAAAAAAAAAAAAAAAAAAAACAAAAAwAAAAAAAECVL+TaXB88hgIAAAATExMTExMTExMTExMTExMTExMTExMTExMTExMTExMTE0DiAQAAAAAAAAAAAAAAAAABAAAAHwAAAAUAAAAAAAAAAAAAAAAAAAAFAAAABgAAAA0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDXsAAAAAAAAAAAAAAAAAAAACAAAABAAAAAQAAAAAAAAAAAAAAAAAAAAXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFwIAAAAAAAAAAAAAAAAAAAABAAAAIAAAAAAAAKDKF3Jtrg8eQwEAAAABAAAAAgAAAA0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDXsAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFwIAAAAAAAAAAAAAAAAAAAADAAAABwAAAAUAAAAAAAAAAAAAAAAAAAAXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFxcXFwIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA="
    #     {
    # innerNode: {
    #     prefixLen: 30,
    #     key: <BN: 2863c1f5cdae42f9540000000>,
    #     children: [ 4, 3 ]
    # }
    # }
    # data = base64.decodebytes(base64_data.encode("ascii"))[32:32+72]

    slab_node = SLAB_NODE_LAYOUT.parse(DATA[32 : 32 + 72])
    assert slab_node.tag == 1
    assert slab_node.node.prefixLen == 30
    assert slab_node.node.children == [4, 3]


def test_parse_header():
    """Test parse slab headers."""
    header = SLAB_HEADER_LAYOUT.parse(DATA[:32])
    assert header.bump_index == 9
    assert header.free_list_length == 2
    assert header.free_list_head == 8


def test_parse_slab():
    slab = SLAB_LAYOUT.parse(DATA)
    assert len(slab.nodes) == 9
    assert slab.nodes[1].tag == 2
    assert slab.nodes[1].node.fee_tier == 0
    assert slab.nodes[1].node.quantity == 321
